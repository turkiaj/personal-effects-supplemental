---
title: "Model cross-validation"
output: html_notebook
---

This is notebook runs model cross-validation. It takes substantial amount of time and so this model generation is separated to this own notebook. The results and stored and analyzed in the main notebook.

For Sysdimet dataset we compute a separate model for every 106 patients where measurements of one patient is left out from the model estimation. Input data of this left out patient is used to predict the patient's response and it is compared to actual blood test values.

```{r setup, include=FALSE}
library(knitr)
library(kableExtra) # for good looking tables

knitr::opts_chunk$set(echo = TRUE, fig.align="center")

# this allows using tikz rendering for plots with "dev=tikz"
knit_hooks$set(plot = function(x, options) {
  if ('tikz' %in% options$dev && !options$external) {
    hook_plot_tex(x, options)
  } else hook_plot_md(x, options)
})

# Fix seed for random number generator for getting consistent results in kmeans etc.
fixed_seed <- 678

# Load common MEBN package
source("mebn/MEBN.r")
```

```{r data_loading, echo=FALSE, message=FALSE}

# Read the data description
datadesc <- read.csv(file="data/SYSDIMET_data_description.csv", header = TRUE, sep = ";")

# Read the actual data matching the description
sysdimet <- read.csv(file="data/SYSDIMET_diet.csv", sep=";", dec=",")

# Define how to iterate through the graph
assumedpredictors <- datadesc[datadesc$Order==100,]    
assumedtargets <- datadesc[datadesc$Order==200,] 
```

The final model candidate with hierarchical Gamma-regression, Regularized Horseshoe-shrinkage and AR(1) autocorrelation process is used in this cross validation.

```{r shrinkage_parameters, echo=TRUE, message=FALSE}
shrinkage_parameters <- within(list(),
{
    scale_icept  <- 1         # prior std for the intercept
    scale_global <- 0.02428   # scale for the half-t prior for tau: 
                              # ((p0=11) / (D=22-11)) * (sigma = 1 / sqrt(n=106*4))
    nu_global    <- 1         # degrees of freedom for the half-t priors for tau
    nu_local     <- 1         # degrees of freedom for the half-t priors for lambdas
    slab_scale   <- 1         # slab scale for the regularized horseshoe
    slab_df      <- 1         # slab degrees of freedom for the regularized horseshoe           
})
```

Here we evaluate a separate model for each k (106) persons at the data while holding out all (4) measurements of one person at the time

```{r nfold_holdout, echo=FALSE, eval=TRUE, message=FALSE}
library(igraph)

# Cross-validation models are stored separate folders, one for each patient.

for (holdout_subject in levels(sysdimet$SUBJECT_ID))
{
  cvdir <- paste0("/media/jari/Jarin WD Passport/cvmodels/", holdout_subject)
  
  if (!dir.exists(cvdir))
  {
    dir.create(cvdir)
  
    holdout_index <- as.vector(as.numeric(sysdimet$SUBJECT_ID == holdout_subject))
  
    initial_graph <- mebn.new_graph_with_randomvariables(datadesc)
    
    sysdimet_gamma_ar1_rhs_cv <- mebn.bipartite_model(reaction_graph = initial_graph, 
                                     inputdata = sysdimet,
                                     targetdata = holdout_index,
                                     predictor_columns = assumedpredictors, 
                                     assumed_targets = assumedtargets, 
                                     group_column = "SUBJECT_ID",
                                     local_estimation = mebn.sampling,
                                     local_model_cache = cvdir, 
                                     stan_model_file = "mebn/BLMM_gamma_ar1_rhs_cv.stan",
                                     reg_params = shrinkage_parameters,
                                     normalize_values = TRUE)
  
    write.graph(sysdimet_gamma_ar1_rhs_cv, paste0(cvdir, "/subject_", holdout_subject, ".graphml", "graphml"))
  }
}
```

Next we can calculate NRMSE and classification metrics for cross-validated personal models

```{r k-fold_nrmse, cache=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
source("model_eval_functions.r")
source("mebn/MEBN.r")

# Array of MSE summaries for each patient

if (file.exists("evaluations/NRMSE-array_MEBNCV.rds"))
{
  nrmse.arr <- readRDS("evaluations/NRMSE-array_MEBNCV.rds")
} else {
  patients <- length(levels(sysdimet$SUBJECT_ID))

  nrmse.arr <- array(-1, 
                   dim = c(1, nrow(assumedtargets)+2, patients),
                   dimnames = list("NRMSE", c("model", as.vector(assumedtargets$Name), "mean"), levels(sysdimet$SUBJECT_ID)))

  saveRDS(nrmse.arr, "evaluations/NRMSE-array_MEBNCV.rds")
}

for (subject in levels(sysdimet$SUBJECT_ID))
{
  stored.mat <- nrmse.arr[,,subject] 
  
  if (stored.mat[1] == -1)
  {
    nrmse.mat <- matrix(0, nrow=0,ncol=7)
    
    personal_nrmse <- matrix(0, nrow=0,ncol=5)
    localfit_directory <- paste0("/media/jari/Jarin WD Passport/cvmodels/", subject, "/")
    
    if (file.exists(localfit_directory))
    {
      print(subject)
      
      pred_response <- get_pred_response(localfit_directory)
      
      if (!is.null(pred_response))
      {
        true_response <- get_true_response_subj(subject)
    
        nrmse_rows <- mebn.NRMSE(pred_response, true_response, mean(true_response))
        nrmse <- rowMeans(nrmse_rows)
    
        personal_nrmse <- rbind(personal_nrmse, nrmse)
      }
    }
  
    model_nrmse <- mean(colMeans(personal_nrmse))
    nrmse.mat <- rbind(nrmse.mat, c("Gamma AR(1) RHS CV", round(colMeans(personal_nrmse), 3), round(model_nrmse, 3)))
    
    nrmse.arr[,,subject] <- nrmse.mat
    
    saveRDS(nrmse.arr, "evaluations/NRMSE-array_MEBNCV.rds")

  } else {
     print(paste0(subject, " is evaluated."))
  }
}

```


```{r k-fold_eval, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
source("model_eval_functions.r")

# Array of summaries for each patient

if (file.exists("evaluations/Class-array_MEBNCV.rds"))
{
  class.arr <- readRDS("evaluations/Class-array_MEBNCV.rds")
} else {
  patients <- length(levels(sysdimet$SUBJECT_ID))

  class.arr <- array(-1, 
                   dim = c(nrow(assumedtargets), 4, patients),
                   dimnames = list(assumedtargets$Name, c('week 4', 'week 8', 'week 12', '12 week change'), levels(sysdimet$SUBJECT_ID)))

  saveRDS(class.arr, "evaluations/Class-array_MEBNCV.rds")
}

for (subject in levels(sysdimet$SUBJECT_ID))
{
  stored.mat <- class.arr[,,subject] 
  
  if (stored.mat[1,1] == -1)
  {
    class.mat <- matrix(0, nrow=nrow(assumedtargets),ncol=4)
    
    localfit_directory <- paste0("/media/jari/Jarin WD Passport/cvmodels/", subject, "/")
    
    if (file.exists(localfit_directory))
    {
      print(subject)
      
      pred_response <- get_pred_response(localfit_directory)
      
      if (!is.null(pred_response))
      {
        true_response <- get_true_response_subj(subject)
      
        pred_delta <- make_delta(pred_response)
        true_delta <- make_delta(true_response)
        
        sign_matrix <- sign(pred_delta) == sign(true_delta)
        avg_change <- sign(rowSums(true_response[,2:4])/3 - true_response[,1]) == sign(rowSums(pred_response[,2:4])/3 - pred_response[,1])
        
        class.mat <- cbind(sign_matrix[,2:4]*1, avg_change*1)
        
        class.arr[,,subject] <- class.mat
      }

      saveRDS(class.arr, "evaluations/Class-array_MEBNCV.rds")
    }
  } else {
    print(paste0(subject, " is evaluated."))
  }
  
}

```



Then we summarize the results of k-fold accuracy cross-validation in a matrix for the main document


```{r nrmse-summary, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

# Separated personal predictions
nrmse.arr <- readRDS("evaluations/NRMSE-array_MEBNCV.rds")

# Add to other evaluations
nrmse.mat <- readRDS(file="evaluations/NRMSE-matrix2.rds")

# Summary vector
nrmse.sum <- rep(0, 6)
number_of_preds <- 0

# Add all the personal prediction matrices
for (subject in levels(sysdimet$SUBJECT_ID))
{
  personal_nrmse <- as.numeric(nrmse.arr[,2:7,subject])

  if (personal_nrmse[1] != -1 && personal_nrmse[1] != "NaN") {
    number_of_preds <- number_of_preds + 1
    nrmse.sum <- nrmse.sum + personal_nrmse
  }
}

nrmse.sum <- nrmse.sum/number_of_preds

nrmse.mat <- rbind(nrmse.mat, c("Gamma AR(1) RHS CV", round(nrmse.sum,3)))

saveRDS(nrmse.mat, "evaluations/NRMSE-matrix3.rds")
```

```{r k-fold-summary, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

# Separated personal predictions
class.arr <- readRDS("evaluations/Class-array_MEBNCV.rds")

# Summary matrix
class.mat <- matrix(0, nrow=nrow(assumedtargets),ncol=4)
rownames(class.mat) <- assumedtargets$Name

number_of_preds <- 0

# Add all the personal prediction matrices
for (subject in levels(sysdimet$SUBJECT_ID))
{
  personal_pred <- class.arr[,,subject]

  if (personal_pred[1,1] != -1) {
    number_of_preds <- number_of_preds + 1
    class.mat <- class.mat + personal_pred
  }
}

class_sum.mat <- class.mat/number_of_preds * 100

class_sum.mat <- cbind(class_sum.mat, rowMeans(class_sum.mat[,1:3]))
colnames(class_sum.mat) <- c('0 to 4 weeks', '4 to 8 weeks', '8 to 12 weeks', 'avg. 12 week change', 'avg. change acc.')

class_sum.mat <- round(class_sum.mat, 0)
class_sum.mat

#saveRDS(class_sum.mat, "evaluations/MEBNCV-matrix.rds")

```